import { Injectable } from '@angular/core';
import { App } from 'ionic-angular';
import { Subject } from 'rxjs/Subject';
import { options } from '../options';

@Injectable()
export class DeviceService {

  orientation$: Subject<string> = new Subject();

  constructor(
    public app: App
  ) {
    window.addEventListener('orientationchange', () => {
      this.orientation$.next(this.getDeviceOrientation());
    }, false);
  }

  getViewType(): string {
    let deviceType = this.getDeviceType();
    let deviceOrientation = this.getDeviceOrientation();
    return deviceType !== 'Desktop' ? deviceType + deviceOrientation : 'Desktop';
  }

  // ----------------------------------------------------------------------------------------------

  private getDeviceOrientation(): 'Portrait' | 'Landscape' {
    if (window.innerHeight < window.innerWidth) {
      return 'Landscape';
    } else {
      return 'Portrait';
    }
  };

  private getDeviceType(): 'Desktop' | 'Phone' | 'Tablet' {
    if (options.device) {
      return options.device;
    } else {
      let isDesktop = this.checkDesktopBrowser();
      if (isDesktop) {
        return 'Desktop';
      }
      let isTablet = this.getViewportDiagonal() > 1000;
      return isTablet ? 'Tablet' : 'Phone';
    }
  };

  private checkDesktopBrowser() {
    return !navigator.userAgent.match(/(iPhone|iPod|iPad|Android|BlackBerry|IEMobile)/);
  }

  private getViewportDiagonal() {
    let viewPortWidth = window.innerWidth;
    let viewPortHeight = window.innerHeight;
    return Math.round(Math.sqrt(Math.pow(viewPortWidth, 2) + Math.pow(viewPortHeight, 2)));
  }

}
