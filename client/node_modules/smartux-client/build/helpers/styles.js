let Logger = require('@ionic/app-scripts/dist/logger/logger').Logger;
let render = require('node-sass').render;
let fs = require('fs-extra');
let path = require('path');

exports.compile = function (context) {
  // MAKE SASS CONFIG:
  let configLogger = new Logger('config');
  let sassConfig = require('../config/sass.config');
  sassConfig.outFile = path.join(context.buildDir, sassConfig.outputFilename);
  sassConfig.includePaths.unshift(context.srcDir);
  let sassImports = require('../config/sass.imports').map(file => '"' + file + '"');
  sassConfig.data = '@charset "UTF-8"; @import ' + sassImports.join(',') + ';';
  configLogger.finish();

  // RUN:
  let sassLogger = new Logger('sass');
  return new Promise((resolve, reject) => {
    render(sassConfig, (sassError, sassResult) => {
      if (sassError) {
        return reject(sassError);
      }
      let buildDir = path.dirname(sassConfig.outFile);
      fs.ensureDirSync(buildDir);
      fs.writeFile(sassConfig.outFile, sassResult.css.toString(), () => {
        sassLogger.finish();
        resolve();
      });
    });
  });

};
